{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
MEGA MENU COMPONENT WITH ICONS AND ANIMATIONS
----------------------------------------------------------------------------------------------------------------------

Render the mega-menu. The mega-menu is a kind of menu optimized for showing a large number of items into several
columns.

********************************************
Supported variables
********************************************

* link: the link from which we need to render the mega-menu. The link must always be a second level link, but it can
        also be empty (no links), which is the case if the merchant only want to show images, for instance.
* block: the block containing all the information about the menu to render
{%- endcomment -%}

{%- comment -%} Fetch all menu icons {%- endcomment -%}
{%- assign menu_icons = shop.metaobjects.menu_icon.values -%}

<div class="mega-menu mega-menu--animated {% if block.settings.images_position == 'left' %}mega-menu--reverse{% endif %}" {{ block.shopify_attributes }}>
  {%- if link.levels > 0 -%}
    <ul class="mega-menu__linklist unstyled-list">
      {%- for sub_link in link.links -%}
        {%- comment -%} Find matching icon for this menu item {%- endcomment -%}
        {%- assign menu_icon = null -%}
        {%- for icon in menu_icons -%}
          {%- if icon.menu_item_title == sub_link.title -%}
            {%- assign menu_icon = icon.icon_image -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
        
        <li class="v-stack justify-items-start gap-5 mega-menu__column-item" style="--item-index: {{ forloop.index0 }}">
          <a href="{{ sub_link.url }}" class="h6 mega-menu__title-with-icon">
            {%- if menu_icon != blank -%}
              <img src="{{ menu_icon | image_url: width: 48 }}" 
                   alt="{{ sub_link.title }}" 
                   class="mega-menu__icon"
                   loading="lazy"
                   width="24"
                   height="24">
            {%- endif -%}
            <span>{{ sub_link.title }}</span>
          </a>

          {%- if sub_link.links.size > 0 -%}
            <ul class="v-stack gap-2.5 unstyled-list">
              {%- for sub_sub_link in sub_link.links -%}
                {%- comment -%} Find matching icon for nested item {%- endcomment -%}
                {%- assign sub_menu_icon = null -%}
                {%- for icon in menu_icons -%}
                  {%- if icon.menu_item_title == sub_sub_link.title -%}
                    {%- assign sub_menu_icon = icon.icon_image -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                
                <li class="mega-menu__sub-item" style="--sub-item-index: {{ forloop.index0 }}">
                  <a href="{{ sub_sub_link.url }}" class="link-faded mega-menu__link-with-icon">
                    {%- if sub_menu_icon != blank -%}
                      <img src="{{ sub_menu_icon | image_url: width: 40 }}" 
                           alt="{{ sub_sub_link.title }}" 
                           class="mega-menu__icon mega-menu__icon--small"
                           loading="lazy"
                           width="20"
                           height="20">
                    {%- endif -%}
                    <span>{{ sub_sub_link.title }}</span>
                  </a>
                </li>
              {%- endfor -%}
            </ul>
          {%- endif -%}
        </li>
      {%- endfor -%}
    </ul>
  {%- endif -%}

  {%- capture mega_menu_content -%}
    {%- render 'mega-menu-images', context: 'menu', block: block -%}
  {%- endcapture -%}

  {%- if mega_menu_content != blank -%}
    <div class="mega-menu__promo mega-menu__promo-animated">
      {{- mega_menu_content -}}
    </div>
  {%- endif -%}
</div>

<style>
  /* Base icon styles */
  .mega-menu__title-with-icon,
  .mega-menu__link-with-icon {
    display: inline-flex !important;
    align-items: center;
    gap: 10px;
  }

  .mega-menu__icon {
    width: 24px;
    height: 24px;
    object-fit: contain;
    flex-shrink: 0;
  }

  .mega-menu__icon--small {
    width: 2.5rem;
    height: 2.5rem;
    opacity: 0.8;
  }

  .mega-menu__link-with-icon:hover .mega-menu__icon--small {
    opacity: 1;
  }

  /* Animation keyframes */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Initial hidden state */
  .mega-menu__column-item,
  .mega-menu__sub-item,
  .mega-menu__promo-animated {
    opacity: 0;
  }

  /* Trigger animations on hover - using :hover on parent navigation item */
  .mega-menu:hover .mega-menu__column-item {
    animation: fadeInUp 0.4s ease forwards;
    animation-delay: calc(var(--item-index) * 0.05s);
  }

  .mega-menu:hover .mega-menu__sub-item {
    animation: fadeInUp 0.3s ease forwards;
    animation-delay: calc(0.1s + var(--sub-item-index) * 0.05s);
  }

  .mega-menu:hover .mega-menu__promo-animated {
    animation: fadeInScale 0.5s ease forwards;
    animation-delay: 0.15s;
  }

  /* Reset animation when not hovering */
  .mega-menu:not(:hover) .mega-menu__column-item,
  .mega-menu:not(:hover) .mega-menu__sub-item,
  .mega-menu:not(:hover) .mega-menu__promo-animated {
    animation: none;
    opacity: 0;
  }

  /* Smooth hover effect on items */
  .mega-menu__link-with-icon {
    transition: transform 0.2s ease, color 0.2s ease;
  }

  .mega-menu__link-with-icon:hover {
    transform: translateX(3px);
  }

  /* Image animation with zoom effect */
  .mega-menu__promo-animated img {
    transition: transform 0.3s ease;
  }

  .mega-menu:hover .mega-menu__promo-animated img {
    transform: scale(1.05);
  }
</style>
{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
MEGA MENU COMPONENT WITH ICONS AND ANIMATIONS
----------------------------------------------------------------------------------------------------------------------

Render the mega-menu. The mega-menu is a kind of menu optimized for showing a large number of items into several
columns.

********************************************
Supported variables
********************************************

* link: the link from which we need to render the mega-menu. The link must always be a second level link, but it can
        also be empty (no links), which is the case if the merchant only want to show images, for instance.
* block: the block containing all the information about the menu to render
{%- endcomment -%}

{%- comment -%} Fetch all menu icons {%- endcomment -%}
{%- assign menu_icons = shop.metaobjects.menu_icon.values -%}

<div class="mega-menu mega-menu--animated {% if block.settings.images_position == 'left' %}mega-menu--reverse{% endif %}" {{ block.shopify_attributes }} data-mega-menu>
  {%- if link.levels > 0 -%}
    <ul class="mega-menu__linklist unstyled-list">
      {%- for sub_link in link.links -%}
        {%- comment -%} Find matching icon for this menu item {%- endcomment -%}
        {%- assign menu_icon = null -%}
        {%- for icon in menu_icons -%}
          {%- if icon.menu_item_title == sub_link.title -%}
            {%- assign menu_icon = icon.icon_image -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
        
        <li class="v-stack justify-items-start gap-5 mega-menu__column-item" style="--item-index: {{ forloop.index0 }}">
          <a href="{{ sub_link.url }}" class="h6 mega-menu__title-with-icon">
            {%- if menu_icon != blank -%}
              <img src="{{ menu_icon | image_url: width: 48 }}" 
                   alt="{{ sub_link.title }}" 
                   class="mega-menu__icon"
                   loading="lazy"
                   width="24"
                   height="24">
            {%- endif -%}
            <span>{{ sub_link.title }}</span>
          </a>

          {%- if sub_link.links.size > 0 -%}
            <ul class="v-stack gap-2.5 unstyled-list">
              {%- for sub_sub_link in sub_link.links -%}
                {%- comment -%} Find matching icon for nested item {%- endcomment -%}
                {%- assign sub_menu_icon = null -%}
                {%- for icon in menu_icons -%}
                  {%- if icon.menu_item_title == sub_sub_link.title -%}
                    {%- assign sub_menu_icon = icon.icon_image -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                
                <li class="mega-menu__sub-item" style="--sub-item-index: {{ forloop.index0 }}">
                  <a href="{{ sub_sub_link.url }}" class="link-faded mega-menu__link-with-icon">
                    {%- if sub_menu_icon != blank -%}
                      <img src="{{ sub_menu_icon | image_url: width: 40 }}" 
                           alt="{{ sub_sub_link.title }}" 
                           class="mega-menu__icon mega-menu__icon--small"
                           loading="lazy"
                           width="20"
                           height="20">
                    {%- endif -%}
                    <span>{{ sub_sub_link.title }}</span>
                  </a>
                </li>
              {%- endfor -%}
            </ul>
          {%- endif -%}
        </li>
      {%- endfor -%}
    </ul>
  {%- endif -%}

  {%- capture mega_menu_content -%}
    {%- render 'mega-menu-images', context: 'menu', block: block -%}
  {%- endcapture -%}

  {%- if mega_menu_content != blank -%}
    <div class="mega-menu__promo mega-menu__promo-animated">
      {{- mega_menu_content -}}
    </div>
  {%- endif -%}
</div>

<script>
  (function() {
    // Function to trigger mega menu animations
    function initMegaMenuAnimations() {
      const megaMenus = document.querySelectorAll('[data-mega-menu]');
      
      megaMenus.forEach(menu => {
        // Find the parent navigation item that triggers this mega menu
        const parentNavItem = menu.closest('li') || menu.closest('.header__menu-item') || menu.parentElement;
        
        if (parentNavItem) {
          let hoverTimeout;
          
          parentNavItem.addEventListener('mouseenter', function() {
            clearTimeout(hoverTimeout);
            // Remove exiting class and add visible class
            menu.classList.remove('mega-menu--exiting');
            hoverTimeout = setTimeout(() => {
              menu.classList.add('mega-menu--visible');
            }, 10);
          });
          
          parentNavItem.addEventListener('mouseleave', function() {
            clearTimeout(hoverTimeout);
            // Add exiting class for exit animation
            menu.classList.remove('mega-menu--visible');
            menu.classList.add('mega-menu--exiting');
            
            // Remove exiting class after animation completes
            setTimeout(() => {
              menu.classList.remove('mega-menu--exiting');
            }, 350); // Slightly shorter to ensure clean transition
          });
        }
      });
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMegaMenuAnimations);
    } else {
      initMegaMenuAnimations();
    }
  })();
</script>

<style>
  /* Base icon styles */
  .mega-menu__title-with-icon,
  .mega-menu__link-with-icon {
    display: inline-flex !important;
    align-items: center;
    gap: 10px;
  }

  .mega-menu__icon {
    width: 24px;
    height: 24px;
    object-fit: contain;
    flex-shrink: 0;
  }

  .mega-menu__icon--small {
    width: 2.5rem;
    height: 2.5rem;
    opacity: 0.8;
  }

  .mega-menu__link-with-icon:hover .mega-menu__icon--small {
    opacity: 1;
  }

  /* Animation keyframes */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeOutDown {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(10px);
    }
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes fadeOutScale {
    from {
      opacity: 1;
      transform: scale(1);
    }
    to {
      opacity: 0;
      transform: scale(0.98);
    }
  }

  @keyframes menuFadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }

  /* Initial hidden state */
  .mega-menu__column-item,
  .mega-menu__sub-item,
  .mega-menu__promo-animated {
    opacity: 0;
  }

  /* ENTRY ANIMATIONS - when mega menu becomes visible */
  .mega-menu--visible .mega-menu__column-item {
    animation: fadeInUp 0.4s ease forwards;
    animation-delay: calc(var(--item-index) * 0.06s);
  }

  .mega-menu--visible .mega-menu__sub-item {
    animation: fadeInUp 0.3s ease forwards;
    animation-delay: calc(0.15s + var(--sub-item-index) * 0.04s);
  }

  .mega-menu--visible .mega-menu__promo-animated {
    animation: fadeInScale 0.6s ease forwards;
    animation-delay: 0.2s;
  }

  /* EXIT ANIMATIONS - when mega menu is closing */
  /* Fade out the entire mega menu container */
  .mega-menu--exiting {
    animation: menuFadeOut 0.3s ease forwards;
  }

  .mega-menu--exiting .mega-menu__column-item {
    animation: fadeOutDown 0.3s ease forwards;
    animation-delay: 0s;
  }

  .mega-menu--exiting .mega-menu__sub-item {
    animation: fadeOutDown 0.25s ease forwards;
    animation-delay: 0s;
  }

  .mega-menu--exiting .mega-menu__promo-animated {
    animation: fadeOutScale 0.3s ease forwards;
    animation-delay: 0s;
  }

  /* Smooth hover effect on items */
  .mega-menu__link-with-icon {
    transition: transform 0.2s ease, color 0.2s ease;
  }

  .mega-menu__link-with-icon:hover {
    transform: translateX(3px);
  }

  /* Image animation with zoom effect */
  .mega-menu__promo-animated img {
    transition: transform 0.4s ease;
  }

  .mega-menu--visible .mega-menu__promo-animated img {
    transform: scale(1.05);
  }

  .mega-menu--exiting .mega-menu__promo-animated img {
    transform: scale(1);
  }
</style>